---
name: Add API integration tests
status: open
created: 2026-01-20T20:36:31Z
updated: 2026-01-20T20:39:01Z
github: https://github.com/elysenko/regression-analyzer/issues/26
depends_on: [25]
parallel: false
conflicts_with: []
---

# Task: Add API integration tests

## Description

Create integration tests for all API endpoints using pytest and FastAPI's TestClient.

## Acceptance Criteria

- [ ] Test file upload with valid CSV
- [ ] Test file upload rejection for invalid types
- [ ] Test analyze endpoint with uploaded file
- [ ] Test results retrieval
- [ ] Test charts endpoint
- [ ] Test health endpoint
- [ ] Test error cases (404, 400)

## Technical Details

### Test File (tests/test_api.py)
```python
import pytest
from fastapi.testclient import TestClient
from regression_analyzer.api import app
import tempfile
import csv

@pytest.fixture
def client():
    return TestClient(app)

@pytest.fixture
def sample_csv():
    """Create a sample CSV file for testing."""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
        writer = csv.writer(f)
        writer.writerow(['x', 'y', 'z'])
        for i in range(10):
            writer.writerow([i, i*2, i*3])
        return f.name

def test_health_check(client):
    response = client.get("/api/v1/health")
    assert response.status_code == 200
    assert "status" in response.json()

def test_upload_csv(client, sample_csv):
    with open(sample_csv, 'rb') as f:
        response = client.post(
            "/api/v1/upload",
            files={"file": ("test.csv", f, "text/csv")}
        )
    assert response.status_code == 200
    assert "upload_id" in response.json()

def test_upload_invalid_type(client):
    response = client.post(
        "/api/v1/upload",
        files={"file": ("test.txt", b"hello", "text/plain")}
    )
    assert response.status_code == 400

def test_analyze_and_results(client, sample_csv):
    # Upload
    with open(sample_csv, 'rb') as f:
        upload_resp = client.post(
            "/api/v1/upload",
            files={"file": ("test.csv", f, "text/csv")}
        )
    upload_id = upload_resp.json()["upload_id"]

    # Analyze
    analyze_resp = client.post(
        "/api/v1/analyze",
        json={"upload_id": upload_id, "skip_llm": True}
    )
    assert analyze_resp.status_code == 200
    job_id = analyze_resp.json()["job_id"]

    # Results
    results_resp = client.get(f"/api/v1/results/{job_id}")
    assert results_resp.status_code == 200
    assert "statistics" in results_resp.json()

def test_missing_job(client):
    response = client.get("/api/v1/results/nonexistent")
    assert response.status_code == 404
```

### Test Dependencies
- pytest
- httpx (used by TestClient)

## Dependencies

- [ ] Task 004: Complete API implementation

## Effort Estimate

- Size: S
- Hours: 2
- Parallel: false (depends on complete API)

## Definition of Done

- [ ] All tests pass
- [ ] Coverage for happy path and error cases
- [ ] Tests can run in CI
